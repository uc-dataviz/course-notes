---
title: "Showing the right numbers"
author: "MACS 24000 <br /> University of Chicago"
output: rcfss::xaringan
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(cache = TRUE, message = FALSE, warning = FALSE, echo = TRUE,
                      fig.retina = 2, fig.align = "center")

set.seed(1234)
```

```{r packages, include = FALSE, cache = FALSE}
library(tidyverse)
library(gapminder)
library(socviz)
library(knitr)
library(broom)
library(forcats)
library(stringr)
library(ggrepel)
library(here)
library(flipbookr)

theme_set(theme_minimal(base_size = rcfss::base_size * .7))
default_width <- c(50, 50, 0)
```

# Grammar of graphics

The **grammar of graphics** is a set of rules for how to produce graphics from data, taking **pieces of data** and **mapping** them to **geometric objects** (like points and lines) that have **aesthetic attributes** (like position, color, and size), together with further rules for **transforming the data if needed**, adjusting **scales**, or projecting the results onto a **coordinate system**.

---

# Grouped data and the `group` aesthetic

.pull-left[

```{r gapminder, eval = FALSE}
ggplot(
  data = gapminder,
  mapping = aes(
    x = year,
    y = gdpPercap
  )
) +
  geom_line()
```

]

.pull-right[

```{r gapminder-out, ref.label = "gapminder", echo = FALSE, eval = TRUE}
```

]

---

# Grouped data and the `group` aesthetic

```{r gapminder-print}
gapminder
```

---

```{r gapminder-group, include = FALSE}
ggplot(data = gapminder, mapping = aes(
  x = year,
  y = gdpPercap
)) +
  geom_line(mapping = aes(group = country))
```

`r chunk_reveal(chunk_name = "gapminder-group", widths = default_width)`

---

```{r gapminder-facet, include = FALSE}
ggplot(data = gapminder, mapping = aes(
  x = year,
  y = gdpPercap
)) +
  geom_line(
    mapping = aes(group = country)
  ) +
  facet_wrap(~continent)
```

`r chunk_reveal(chunk_name = "gapminder-facet", widths = default_width)`

---


```{r labs, include = FALSE}
ggplot(data = gapminder, mapping = aes(
  x = year,
  y = gdpPercap
)) +
  geom_line(
  color = "gray70",
  mapping = aes(group = country)
) +
  geom_smooth(
    size = 1.1,
    method = "loess",
    se = FALSE
  ) +
  scale_y_log10(labels = scales::dollar) +
  facet_wrap(~continent, ncol = 5) +
  labs(
    x = "Year",
    y = "GDP per capita",
    title = "GDP per capita on Five Continents"
  )
```

`r chunk_reveal(chunk_name = "labs", font_size_code = "60%", widths = default_width)`

---

# Geoms can transform data

```{r gss}
gss_sm
```

---

# Geoms can transform data

```{r gss-relig}
count(x = gss_sm, religion)
```

---

```{r obtain-count, include = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(x = bigregion)
) +
  geom_bar()
```

`r chunk_reveal(chunk_name = "obtain-count", widths = default_width)`

---

```{r prop-wrong, include = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(x = bigregion)
) +
  geom_bar(mapping = aes(
    y = stat(prop))
  )
```

`r chunk_reveal(chunk_name = "prop-wrong", widths = default_width)`

---

```{r prop-right, include = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(x = bigregion)
) +
  geom_bar(mapping = aes(
    y = stat(prop),
    group = 1)
  )
```

`r chunk_reveal(chunk_name = "prop-right", widths = default_width)`

---

# `geom_*() <=> stat_*()`

```r
p + geom_bar()

p + stat_count()
```

---

# Color in a bar chart

---

```{r bar-chart-color, eval = FALSE, echo = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(x = religion) #ROTATE
  mapping = aes(x = religion, color = religion) #ROTATE
  mapping = aes(x = religion, fill = religion) #ROTATE
  ) +
  geom_bar()
```

`r chunk_reveal(chunk_name = "bar-chart-color", break_type = "rotate", widths = default_width)`

---

# Histograms and kernel densities

```{r midwest}
midwest
```

---

```{r histogram, include = FALSE}
ggplot(
  data = midwest,
  mapping = aes(x = area)
) +
  geom_histogram()
```

`r chunk_reveal(chunk_name = "histogram", widths = default_width)`

---

```{r histogram-10-bins, include = FALSE}
ggplot(
  data = midwest,
  mapping = aes(x = area)
) +
  geom_histogram(bins = 10)
```

`r chunk_reveal(chunk_name = "histogram-10-bins", widths = default_width)`

---

```{r subset-fly, include = FALSE}
ggplot(
  data = filter(
    midwest,
    state %in% c("OH", "WI")
  ),
  mapping = aes(x = percollege,
                fill = state)
) +
  geom_histogram(
    position = "identity",
    alpha = 0.4, bins = 20
  )
```

`r chunk_reveal(chunk_name = "subset-fly", widths = default_width)`

---

```{r density, include = FALSE}
ggplot(
  data = midwest,
  mapping = aes(x = area)
) +
  geom_density()
```

`r chunk_reveal(chunk_name = "density", widths = default_width)`

---

```{r density-fill, include = FALSE}
ggplot(
  data = midwest,
  mapping = aes(
    x = area,
    fill = state,
    color = state
  )
) +
  geom_density(alpha = 0.3)
```

`r chunk_reveal(chunk_name = "density-fill", widths = default_width)`

---

# Avoiding transformations when necessary

```{r titanic}
titanic
```

---

```{r titanic-bar, include = FALSE}
ggplot(
  data = titanic,
  mapping = aes(
    x = fate,
    y = percent,
    fill = sex
  )
) +
  geom_bar(stat = "identity", position = "dodge") + #ROTATE
  geom_col(position = "dodge") + #ROTATE
  theme(legend.position = "top")
```

`r chunk_reveal(chunk_name = "titanic-bar", break_type = "rotate", widths = default_width)`

---

```{r oecd}
oecd_sum
```

---

```{r oecd-plot, include = FALSE}
ggplot(
  data = oecd_sum,
  mapping = aes(x = year,
                y = diff,
                fill = hi_lo)
) +
  geom_col() +
  guides(fill = FALSE) +
  labs(
    x = NULL, y = "Difference in Years",
    title = "The US Life Expectancy Gap",
    subtitle = "Difference between US and OECD average life expectancies, 1960-2015",
    caption = "Data: OECD. After a chart by Christopher Ingraham, Washington Post, December 27th 2017."
  )
```

`r chunk_reveal(chunk_name = "oecd-plot", widths = default_width)`

---

# Cross-tabulation the awkward way

* Cross-classify two categorical variables using color
* Equivalent to a frequency table
* How to achieve within `ggplot()`?

---

```{r region-religion, include = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(
    x = bigregion,
    fill = religion
  )
) +
  geom_bar()
```

`r chunk_reveal(chunk_name = "region-religion", widths = default_width)`

---

```{r region-religion-fill, include = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(
    x = bigregion,
    fill = religion
  )
) +
  geom_bar(position = "fill")
```

`r chunk_reveal(chunk_name = "region-religion-fill", widths = default_width)`

---

```{r region-religion-dodge, include = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(
    x = bigregion,
    fill = religion
  )
) +
  geom_bar(position = "dodge")
```

`r chunk_reveal(chunk_name = "region-religion-dodge", widths = default_width)`

---

```{r region-religion-dodge-prop, include = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(
    x = bigregion,
    fill = religion
  )
) +
  geom_bar(
    mapping = aes(y = stat(prop)),
    position = "dodge"
  )
```

`r chunk_reveal(chunk_name = "region-religion-dodge-prop", widths = default_width)`

---

```{r region-religion-dodge-prop-religion, include = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(
    x = bigregion,
    fill = religion
  )
) +
  geom_bar(
    mapping = aes(
      y = stat(prop),
      group = religion
    ),
    position = "dodge")
```

`r chunk_reveal(chunk_name = "region-religion-dodge-prop-religion", widths = default_width)`

---

```{r region-religion-facet, include = FALSE}
ggplot(
  data = gss_sm,
  mapping = aes(x = religion)
) +
  geom_bar(
    mapping = aes(
      y = stat(prop),
      group = bigregion
    ),
    position = "dodge"
  ) +
  facet_wrap(~bigregion)
```

`r chunk_reveal(chunk_name = "region-religion-facet", widths = default_width)`

---

<div style="width:100%;height:0;padding-bottom:60%;position:relative;"><iframe src="https://giphy.com/embed/y9v6gGKHjBX7W" width="100%" height="100%" style="position:absolute" frameBorder="0" class="giphy-embed" allowFullScreen></iframe></div>

---

# Use `dplyr` to summarize manually

```{r rel-by-region}
(rel_by_region <- gss_sm %>%
  count(bigregion, religion) %>%
  mutate(
    freq = n / sum(n),
    pct = round((freq * 100), 0)
  ) %>%
  drop_na())
```

---

```{r rel-by-region-plot, include = FALSE}
ggplot(
  data = rel_by_region,
  mapping = aes(
    x = bigregion,
    y = pct,
    fill = religion
  )
) +
  geom_col(position = "dodge2") +
  labs(x = "Region",
       y = "Percent",
       fill = "Religion") +
  theme(legend.position = "top")
```

`r chunk_reveal(chunk_name = "rel-by-region-plot", widths = default_width)`

---

```{r rel-by-region-plot-facet, include = FALSE}
ggplot(
  data = rel_by_region,
  mapping = aes(
    x = religion,
    y = pct,
    fill = religion
  )
) +
  geom_col(position = "dodge2") +
  labs(x = "Region",
       y = "Percent",
       fill = "Religion") +
  guides(fill = FALSE) +
  coord_flip() +
  facet_grid(~bigregion)
```

`r chunk_reveal(chunk_name = "rel-by-region-plot-facet", widths = default_width)`

---

# Continuous variables by group or category

```{r organdata}
glimpse(organdata)
```

---

```{r organ-box, include = FALSE}
ggplot(
  data = organdata,
  mapping = aes(x = country,
                y = donors)
) +
  geom_boxplot() +
  coord_flip()
```

`r chunk_reveal(chunk_name = "organ-box", widths = default_width)`

---

```{r organ-reorder, include = FALSE}
ggplot(
  data = organdata,
  mapping = aes(
    x = reorder(x = country,
                X = donors,
                na.rm = TRUE),
    y = donors
  )
) +
  geom_boxplot() +
  labs(x = NULL) +
  coord_flip()
```

`r chunk_reveal(chunk_name = "organ-reorder", widths = default_width)`

---

```{r organ-world, include = FALSE}
ggplot(
  data = organdata,
  mapping = aes(
    x = reorder(x = country,
                X = donors,
                na.rm = TRUE),
    y = donors, fill = world
  )
) +
  geom_boxplot() +
  labs(x = NULL) +
  coord_flip() +
  theme(legend.position = "bottom")
```

`r chunk_reveal(chunk_name = "organ-world", widths = default_width)`

---

```{r strip-chart, include = FALSE}
ggplot(
  data = organdata,
  mapping = aes(
    x = reorder(x = country,
                X = donors,
                na.rm = TRUE),
    y = donors, color = world
  )
) +
  geom_point() + #ROTATE
  geom_jitter() + #ROTATE
  labs(x = NULL) +
  coord_flip() +
  theme(legend.position = "bottom")
```

`r chunk_reveal(chunk_name = "strip-chart", break_type = "rotate", widths = default_width)`

---

# Prep data

```{r organ-sum}
(by_country <- organdata %>%
  group_by(consent_law, country) %>%
  summarize(
    donors_mean = mean(donors, na.rm = TRUE),
    donors_sd = sd(donors, na.rm = TRUE),
    gdp_mean = mean(gdp, na.rm = TRUE),
    health_mean = mean(health, na.rm = TRUE),
    roads_mean = mean(roads, na.rm = TRUE),
    cerebvas_mean = mean(cerebvas, na.rm = TRUE)
  ))
```

---

# Prep data

```{r organ-sum-efficient}
(by_country <- organdata %>%
  group_by(consent_law, country) %>%
  summarize(across(where(is.numeric), list(mean = mean, sd = sd), na.rm = TRUE)) %>%
  ungroup())
```

---

```{r organ-donor-mean, include = FALSE}
ggplot(
  data = by_country,
  mapping = aes(
    x = donors_mean,
    y = reorder(country, donors_mean),
    color = consent_law
  )
) +
  geom_point(size = 3) +
  labs(
    x = "Donor Procurement Rate",
    y = "", color = "Consent Law"
  ) +
  theme(legend.position = "top")
```

`r chunk_reveal(chunk_name = "organ-donor-mean", widths = default_width)`

---

```{r organ-donor-facet, include = FALSE}
ggplot(
  data = by_country,
  mapping = aes(
    x = donors_mean,
    y = reorder(country,
                donors_mean)
  )
) +
  geom_point(size = 3) +
  facet_wrap(~consent_law, ncol = 1) +
  labs(
    x = "Donor Procurement Rate",
    y = "", color = "Consent Law"
  )
```

`r chunk_reveal(chunk_name = "organ-donor-mean", widths = default_width)`

---

```{r organ-free-scale-y, include = FALSE}
ggplot(
  data = by_country,
  mapping = aes(
    x = donors_mean,
    y = reorder(country,
                donors_mean)
  )
) +
  geom_point(size = 3) +
  facet_wrap(~consent_law, scales = "free_y", ncol = 1) +
  labs(
    x = "Donor Procurement Rate",
    y = "", color = "Consent Law"
  )
```

`r chunk_reveal(chunk_name = "organ-donor-mean", widths = default_width)`

---

```{r organ-donor-sd, include = FALSE}
ggplot(
  data = by_country,
  mapping = aes(
    x = reorder(country,
                donors_mean),
    y = donors_mean
  )
) +
  geom_pointrange(mapping = aes(
    ymin = donors_mean - donors_sd,
    ymax = donors_mean + donors_sd
  )) +
  labs(
    x = "",
    y = "Donor Procurement Rate"
  ) +
  coord_flip()
```

`r chunk_reveal(chunk_name = "organ-donor-sd", widths = default_width)`

---

# Plot text directly

---

```{r geom-text, eval = FALSE, echo = FALSE}
ggplot(
  data = by_country,
  mapping = aes(
    x = roads_mean,
    y = donors_mean
  )
) +
  geom_point() +
  geom_text(aes(label = country)) #ROTATE
  geom_text(aes(label = country, hjust = 0)) #ROTATE
```

`r chunk_reveal(chunk_name = "geom-text", break_type = "rotate", widths = default_width)`

---

# `ggrepel::geom_text_repel()`

```{r elections}
elections_historic %>%
  select(2:7)
```

---

```{r elections-plot}
p_title <- "Presidential Elections: Popular & Electoral College Margins"
p_subtitle <- "1824-2016"
p_caption <- "Data for 2016 are provisional."
x_label <- "Winner's share of Popular Vote"
y_label <- "Winner's share of Electoral College Votes"
```

---

```{r elections-plot-draw, dependson = "elections-plot", include = FALSE}
ggplot(data = elections_historic,
       mapping = aes(
         x = popular_pct,
         y = ec_pct,
         label = winner_label
       )) +
  geom_hline(yintercept = 0.5,
             size = 1.4,
             color = "gray80") +
  geom_vline(xintercept = 0.5,
             size = 1.4,
             color = "gray80") +
  geom_point() +
  geom_text_repel() +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = x_label, y = y_label,
    title = p_title, subtitle = p_subtitle,
    caption = p_caption
  )
```

`r chunk_reveal(chunk_name = "elections-plot-draw", font_size_code = "60%", widths = default_width)`

---

```{r label-outliers, include = FALSE}
ggplot(
  data = by_country,
  mapping = aes(x = gdp_mean,
                y = health_mean)
) +
  geom_point() +
  geom_text_repel(
    data = filter(by_country, gdp_mean > 25000),
    mapping = aes(label = country)
  )
```

`r chunk_reveal(chunk_name = "label-outliers", widths = default_width)`

---

```{r label-outliers-2, include = FALSE}
ggplot(
  data = by_country,
  mapping = aes(x = gdp_mean,
                y = health_mean)
) +
  geom_point() +
  geom_text_repel(
    data = filter(
      by_country,
      gdp_mean > 25000 | health_mean < 1500 |
        country %in% "Belgium"
    ),
    mapping = aes(label = country)
  )
```

`r chunk_reveal(chunk_name = "label-outliers-2", widths = default_width)`

---

```{r gapminder-scales, include = FALSE}
ggplot(
  data = gapminder,
  mapping =
    aes(
      x = gdpPercap,
      y = lifeExp,
      color = continent,
      fill = continent
    )
) +
  geom_point() +
  geom_smooth(method = "loess") +
  scale_x_log10()
```

`r chunk_reveal(chunk_name = "gapminder-scales", widths = default_width)`

---

# Scales, guides, and themes

Scale functions control scale mappings in geoms. Remember: not just `x` and `y` but also `color`, `fill`, `shape`, and `size` are scales. They visually represent quantities or categories in your data -- thus, they have a scale associated with that
representation. This means you control things like color schemes for data mappings through **scale functions**.

```r
scale_<MAPPING>_<KIND>()

scale_x_continuous()
scale_y_continuous()
scale_x_discrete()
scale_y_discrete()
scale_x_log10()
scale_x_sqrt()
```

---

```{r labs-breaks-limits, include = FALSE}
ggplot(
  data = organdata,
  mapping = aes(
    x = roads,
    y = donors,
    color = world
  )
) +
  geom_point() +
  scale_x_log10() +
  scale_y_continuous(
    breaks = c(5, 15, 25),
    labels = c("Five", "Fifteen", "Twenty Five")
  )
```

`r chunk_reveal(chunk_name = "labs-breaks-limits", widths = default_width)`

---

```{r scale-color, include = FALSE}
ggplot(
  data = organdata,
  mapping = aes(
    x = roads,
    y = donors,
    color = world
  )
) +
  geom_point() +
  scale_color_discrete(
    labels =
      c(
        "Corporatist", "Liberal",
        "Social Democratic", "Unclassified"
      )
  ) +
  labs(
    x = "Road Deaths",
    y = "Donor Procurement",
    color = "Welfare State"
  )
```

`r chunk_reveal(chunk_name = "scale-color", font_size_code = "50%", widths = default_width)`

---

```{r guides-off, include = FALSE}
ggplot(data = organdata,
       mapping = aes(
         x = roads,
         y = donors,
         color = world
       )) +
  geom_point() +
  labs(
    x = "Road Deaths",
    y = "Donor Procurement"
  ) +
  guides(color = FALSE)
```

`r chunk_reveal(chunk_name = "guides-off", widths = default_width)`

---

# Midday break

```{r take-a-break, echo = FALSE}
knitr::include_graphics("https://i0.wp.com/redgalmusings.com/wp-content/uploads/2018/10/take-a-break-hamilton.gif")
```

---

# Mapping data to graphics

## General process

* Loading data
* Clean it up
* Map specific column to aesthetics

--


* [BBC Children in Need](https://www.bbcchildreninneed.co.uk/)

---

# Load and clean data

```{r load-libraries-map-data, warning=FALSE, message=FALSE}
# Load libraries
library(tidyverse)  # For ggplot, dplyr, and friends
library(readxl)     # For reading Excel files
library(lubridate)  # For working with dates
```

```{r load-bbc-data, include=FALSE, warning=FALSE}
bbc_raw <- read_excel(here::here("data", "360-giving-data.xlsx"))
```

```{r bbc-data}
glimpse(bbc_raw)
```

---

# Clean the data

```{r clean-bbc-data}
bbc <- bbc_raw %>% 
  # Extract the year from the award date
  mutate(grant_year = year(`Award Date`)) %>% 
  # Rename some columns
  rename(grant_amount = `Amount Awarded`,
         grant_program = `Grant Programme:Title`,
         grant_duration = `Planned Dates:Duration (months)`) %>% 
  # Make a new text-based version of the duration column, recoding months
  # between 12-23, 23-35, and 36+. The case_when() function here lets us use
  # multiple if/else conditions at the same time.
  mutate(grant_duration_text = case_when(
    grant_duration >= 12 & grant_duration < 24 ~ "1 year",
    grant_duration >= 24 & grant_duration < 36 ~ "2 years",
    grant_duration >= 36 ~ "3 years"
  )) %>% 
  # Get rid of anything before 2016
  filter(grant_year > 2015) %>% 
  # Make a categorical version of the year column
  mutate(grant_year_category = factor(grant_year))
```

---

```{r hist-basic, eval = FALSE, echo = FALSE}
ggplot(data = bbc,
       mapping = aes(x = grant_amount)) +
  geom_histogram()#ROTATE
  geom_histogram(binwidth = 100000)#ROTATE
  geom_histogram(binwidth = 500)#ROTATE
  geom_histogram(binwidth = 10000, color = "white")#ROTATE
  geom_histogram(aes(fill = grant_year_category), binwidth = 10000, color = "white")#ROTATE
```

`r chunk_reveal(chunk_name = "hist-basic", break_type = "rotate", widths = default_width)`

---

```{r hist-facet-fill, include = FALSE}
ggplot(bbc, aes(x = grant_amount, fill = grant_year_category)) +
  geom_histogram(binwidth = 10000, color = "white") +
  facet_wrap(vars(grant_year))
```

`r chunk_reveal(chunk_name = "hist-facet-fill", widths = default_width)`

---


```{r points-initial, eval = FALSE, echo = FALSE}
ggplot(bbc,
       aes(x = grant_year_category,
           y = grant_amount)) +
  geom_point() #ROTATE
  geom_point(alpha = .1) #ROTATE
  geom_point(position = position_jitter()) #ROTATE
  geom_point(position = position_jitter(height = 0)) #ROTATE
  geom_point(aes(color = grant_program), position = position_jitter(height = 0)) #ROTATE
```

`r chunk_reveal(chunk_name = "points-initial", break_type = "rotate", widths = default_width)`

---

```{r boxplot, include = FALSE}
ggplot(bbc,
       aes(x = grant_year_category,
           y = grant_amount,
           color = grant_program)) +
  geom_boxplot()
```

`r chunk_reveal(chunk_name = "boxplot", widths = default_width)`

---

# Summaries

```{r make-data-year}
bbc_by_year <- bbc %>% 
  group_by(grant_year) %>%
  summarize(total = sum(grant_amount), 
            avg = mean(grant_amount),
            number = n())

bbc_by_year
```

---

```{r plot-year-summaries, eval = FALSE, echo = FALSE}
ggplot(bbc_by_year,
       aes(
         x = grant_year,
         y = avg#ROTATE
         y = total#ROTATE
         y = number#ROTATE
       )
) +
  geom_col()
```

`r chunk_reveal(chunk_name = "plot-year-summaries", break_type = "rotate", widths = default_width)`

---

# Incorporate additional aesthetics

```{r make-data-year-size}
bbc_year_size <- bbc %>% 
  group_by(grant_year, grant_program) %>% 
  summarize(total = sum(grant_amount),
            avg = mean(grant_amount),
            number = n())
bbc_year_size
```

---

```{r plot-year-size, include = FALSE}
ggplot(bbc_year_size,
       aes(x = grant_year,
           y = total,
           fill = grant_program)) +
  geom_col()
```

`r chunk_reveal(chunk_name = "plot-year-size", widths = default_width)`

---

```{r plot-year-size-dodge, include = FALSE}
ggplot(bbc_year_size,
       aes(x = grant_year,
           y = total,
           fill = grant_program)) +
  geom_col(position = position_dodge())
```

`r chunk_reveal(chunk_name = "plot-year-size-dodge", widths = default_width)`

---

```{r plot-year-size-facet, include = FALSE}
ggplot(bbc_year_size,
       aes(x = grant_year,
           y = total,
           fill = grant_program)) +
  geom_col() +
  facet_wrap(vars(grant_program))
```

`r chunk_reveal(chunk_name = "plot-year-size-facet", widths = default_width)`

---

```{r plot-year-size-col, include = FALSE}
ggplot(bbc_year_size,
       aes(x = grant_year,
           y = total,
           fill = grant_program)) +
  geom_col() +
  facet_wrap(vars(grant_program), ncol = 1)
```

`r chunk_reveal(chunk_name = "plot-year-size-col", widths = default_width)`

---

# One more time

```{r make-data-year-size-duration}
bbc_year_size_duration <- bbc %>% 
  group_by(grant_year, grant_program, grant_duration_text) %>% 
  summarize(total = sum(grant_amount),
            avg = mean(grant_amount),
            number = n())
bbc_year_size_duration
```

---

```{r plot-year-size-duration, include = FALSE}
ggplot(bbc_year_size_duration,
       aes(x = grant_year,
           y = number,
           fill = grant_program)) +
  geom_col(position = position_dodge(preserve = "single")) +
  facet_wrap(vars(grant_duration_text), ncol = 1)
```

`r chunk_reveal(chunk_name = "plot-year-size-duration", widths = default_width)`

---

# Number of daily births in the US

- `US_births_1994-2003_CDC_NCHS.csv` contains U.S. births data for the years 1994 to 2003, as provided by the Centers for Disease Control and Prevention’s National Center for Health Statistics.
- `US_births_2000-2014_SSA.csv` contains U.S. births data for the years 2000 to 2014, as provided by the Social Security Administration.

---

# Load and clean data

```{r load-libraries-data-fake, eval=FALSE}
library(tidyverse)
library(scales)   # For nice labels in charts

births_1994_1999 <- read_csv("data/US_births_1994-2003_CDC_NCHS.csv") %>% 
  # Ignore anything after 2000
  filter(year < 2000)
births_2000_2014 <- read_csv("data/US_births_2000-2014_SSA.csv")
births_combined <- bind_rows(births_1994_1999, births_2000_2014)
```

```{r load-libraries-data-real, include=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(scales)
births_1994_1999 <- read_csv(here::here( "data", "US_births_1994-2003_CDC_NCHS.csv")) %>%
  # Ignore anything after 2000
  filter(year < 2000)
births_2000_2014 <- read_csv(here::here("data", "US_births_2000-2014_SSA.csv"))
births_combined <- bind_rows(births_1994_1999, births_2000_2014)
```

---

# Wrangle data

```{r head-data}
births_combined
```

---

# Wrangle data

```{r wrangle-data}
month_names <- c("January", "February", "March", "April", "May", "June", "July",
                 "August", "September", "October", "November", "December")

day_names <- c("Monday", "Tuesday", "Wednesday", 
               "Thursday", "Friday", "Saturday", "Sunday")

births <- births_combined %>% 
  mutate(month = factor(month, labels = month_names, ordered = TRUE)) %>% 
  mutate(day_of_week = factor(day_of_week, labels = day_names, ordered = TRUE),
         date_of_month_categorical = factor(date_of_month)) %>% 
  mutate(weekend = ifelse(day_of_week %in% c("Saturday", "Sunday"), TRUE, FALSE))

head(births)
```

---

# Bar plot

```{r plot-bar-data}
(total_births_weekday <- births %>% 
  group_by(day_of_week) %>% 
  summarize(total = sum(births)))
```

---

```{r plot-bar-chart, include = FALSE}
ggplot(data = total_births_weekday,
       mapping = aes(
         x = day_of_week,
         y = total,
         fill = day_of_week
       )) +
  geom_col() +
  guides(fill = FALSE)
```

`r chunk_reveal(chunk_name = "plot-bar-chart", widths = default_width)`

---

# Add informative color

```{r plot-bar-chart-weekend-data}
(total_births_weekday <- births %>% 
  group_by(day_of_week) %>% 
  summarize(total = sum(births)) %>% 
  mutate(weekend = day_of_week %in% c("Saturday", "Sunday")))
```

---

```{r plot-bar-chart-weekend, include = FALSE}
ggplot(data = total_births_weekday,
       mapping = aes(
         x = day_of_week,
         y = total,
         fill = weekend
       )) +
  geom_col()+
  scale_fill_manual(values = c("grey70", "#f2ad22")) +
  scale_y_continuous(labels = comma) +
  guides(fill = FALSE) +
  labs(title = "Weekends are unpopular times for giving birth",
       x = NULL, y = "Total births")
```

`r chunk_reveal(chunk_name = "plot-bar-chart-weekend", widths = default_width)`

---

# Lollipop chart

---

```{r plot-lollipop-chart-weekend-better, include = FALSE}
ggplot(data = total_births_weekday,
       mapping = aes(
         x = day_of_week,
         y = total,
         color = weekend
         )) +
  geom_pointrange(aes(ymin = 0, ymax = total),
                  fatten = 5, size = 1.5) +
  scale_color_manual(values = c("grey70", "#f2ad22")) +
  scale_y_continuous(labels = comma) +
  guides(color = FALSE) +
  labs(title = "Weekends are unpopular times for giving birth",
       x = NULL, y = "Total births")
```

`r chunk_reveal(chunk_name = "plot-lollipop-chart-weekend-better", widths = default_width)`

---

# Strip chart

---

```{r strip-plot, include = FALSE}
ggplot(data = births,
       mapping = aes(x = day_of_week,
                     y = births,
                     color = weekend)) +
  scale_color_manual(values = c("grey70", "#f2ad22")) +
  geom_point(size = 0.5, position = position_jitter(height = 0)) +
  guides(color = FALSE)
```

`r chunk_reveal(chunk_name = "strip-plot", widths = default_width)`

---

# Beeswarm plot

* [**ggbeeswarm** package](https://github.com/eclarke/ggbeeswarm)

---

```{r beeswarm-plot, include = FALSE}
library(ggbeeswarm)

ggplot(data = births,
       mapping = aes(
         x = day_of_week,
         y = births,
         color = weekend
       )) +
  scale_color_manual(
    values = c("grey70",
               "#f2ad22")
    ) +
  geom_quasirandom(size = 0.0001) +
  guides(color = FALSE)
```

`r chunk_reveal(chunk_name = "beeswarm-plot", widths = default_width)`

---

# Heatmap

```{r}
(avg_births_month_day <- births %>% 
  group_by(month, date_of_month_categorical) %>% 
  summarize(avg_births = mean(births)))
```

---

```{r plot-heatmap, include = FALSE}
ggplot(data = avg_births_month_day,
       mapping = aes(x = date_of_month_categorical, y = fct_rev(month), fill = avg_births)) +
  geom_tile() +
  scale_fill_viridis_c(option = "inferno", labels = comma) + 
  labs(x = "Day of the month", y = NULL,
       title = "Average births per day",
       subtitle = "1994-2014",
       fill = "Average births") +
  coord_equal()
```

`r chunk_reveal(chunk_name = "plot-heatmap", widths = default_width)`

---

```{r plot-heatmap-out, ref.label = "plot-heatmap", include = TRUE, echo = FALSE, fig.width = 12}
```

---

# Comparisons

* [World Bank's Open Data portal](https://data.worldbank.org/)

---

# Load and clean data

```{r load-libraries-comparisons}
library(tidyverse)  # For ggplot, dplyr, and friends
library(WDI)        # For getting data from the World Bank
library(geofacet)   # For map-shaped facets
library(scales)     # For helpful scale functions like dollar()
library(ggrepel)    # For non-overlapping labels
```

---

# Get indicators

```{r load-data-real, include=FALSE}
wdi_raw <- read_csv(here::here("data", "wdi_raw.csv"))
```

```{r wdi-data}
glimpse(wdi_raw)
```

---

# Clean the data

```{r clean-wdi-data}
wdi_clean <- wdi_raw %>% 
  filter(region != "Aggregates") %>% 
  select(iso2c, country, year, 
         life_expectancy = SP.DYN.LE00.IN, 
         access_to_electricity = EG.ELC.ACCS.ZS, 
         co2_emissions = EN.ATM.CO2E.PC, 
         gdp_per_cap = NY.GDP.PCAP.KD, 
         region, income)

head(wdi_clean)
```

---

# Small multiples

```{r life-expectancy-small-data}
life_expectancy_small <- wdi_clean %>%
  filter(country %in% c("Afghanistan", "Belarus", "India",
                        "Mexico", "New Zealand", "Spain"))
```

---

```{r life-expectancy-small, include = FALSE}
ggplot(data = life_expectancy_small, 
       mapping = aes(
         x = year,
         y = life_expectancy
       )) +
  geom_line(size = 1) +
  facet_wrap(vars(country))
```

`r chunk_reveal(chunk_name = "life-expectancy-small", widths = default_width)`

---

```{r life-expectancy-small-minimalist, include = FALSE}
ggplot(data = life_expectancy_small, 
       mapping = aes(
         x = year,
         y = life_expectancy
       )) +
  geom_line(size = 1) +
  facet_wrap(vars(country), scales = "free_y") +
  theme_void() +
  theme(strip.text = element_text(face = "bold"))
```

`r chunk_reveal(chunk_name = "life-expectancy-small-minimalist", widths = default_width)`

---

# MENA countries

```{r life-expectancy-mena-data}
life_expectancy_mena <- wdi_clean %>% 
  filter(region == "Middle East & North Africa")
```

---

```{r life-expectancy-mena, include = FALSE}
ggplot(data = life_expectancy_mena, 
       mapping = aes(
         x = year,
         y = life_expectancy
       )) +
  geom_line(size = 1) +
  facet_wrap(vars(country),
             scales = "free_y",
             nrow = 5) +
  theme_void() +
  theme(strip.text = element_text(face = "bold"))
```

`r chunk_reveal(chunk_name = "life-expectancy-mena", widths = default_width)`

---

# `geofacet`

* Arrange facets by geography

---

```{r life-expectancy-eu, include = FALSE}
life_expectancy_eu <- wdi_clean %>% 
  filter(region == "Europe & Central Asia")

ggplot(life_expectancy_eu,
       aes(x = year,
           y = life_expectancy)) +
  geom_line(size = 1) +
  facet_geo(vars(country),
            grid = "eu_grid1",
            scales = "free_y") +
  labs(x = NULL, y = NULL,
       title = "Life expectancy from 1995–2015",
       caption = "Source: The World Bank (SP.DYN.LE00.IN)") +
  theme(strip.text = element_text(face = "bold"),
        plot.title = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

`r chunk_reveal(chunk_name = "life-expectancy-eu", widths = default_width)`

---

# Sparklines

Sparklines are just line charts (or bar charts) that are really really small

```{r india-spark, fig.width=1, fig.height=0.15, fig.asp = NULL, out.width = NULL, warning=FALSE}
india_co2 <- wdi_clean %>% 
  filter(country == "India")

plot_india <- ggplot(india_co2, aes(x = year, y = co2_emissions)) +
  geom_line() +
  theme_void()
plot_india
```

---

# Sparklines

```{r china-spark, fig.width=1, fig.height=0.15, fig.asp = NULL, out.width = NULL, warning=FALSE}
china_co2 <- wdi_clean %>% 
  filter(country == "China")

plot_china <- ggplot(china_co2, aes(x = year, y = co2_emissions)) +
  geom_line() +
  theme_void()
plot_china
```

---

# Sparklines

> Both India <img class="img-inline" src="https://data-mining-viz.netlify.app/images/india-spark-1.png" width = "100"/> and China <img class="img-inline" src="https://data-mining-viz.netlify.app/images/china-spark-1.png" width = "100"/> have seen increased CO~2~ emissions over the past 20 years.

---

# Slopegraphs

```{r slopegraph-sa-data}
gdp_south_asia <- wdi_clean %>% 
  filter(region == "South Asia") %>% 
  filter(year %in% c(1995, 2015)) %>% 
  # Look at each country individually
  group_by(country) %>%
  # Remove the country if any of its gdp_per_cap values are missing
  filter(!any(is.na(gdp_per_cap))) %>%
  ungroup() %>%
  # Make year a factor
  mutate(year = factor(year)) %>% 
  # Make some nice label columns
  # If the year is 1995, format it like "Country name: $GDP". If the year is
  # 2015, format it like "$GDP"
  mutate(label_first = ifelse(year == 1995, str_c(country, ": ", dollar(round(gdp_per_cap))), NA),
         label_last = ifelse(year == 2015, dollar(round(gdp_per_cap, 0)), NA))
```

---

```{r slopegraph-sa-simple-text, include = FALSE}
ggplot(gdp_south_asia,
       aes(x = year,
           y = gdp_per_cap,
           group = country,
           color = country)) +
  geom_line(size = 1.5) +
  geom_text(aes(label = country)) +
  guides(color = FALSE)
```

`r chunk_reveal(chunk_name = "slopegraph-sa-simple-text", widths = default_width)`

---

```{r slopegraph-sa-simple-text-fancier, include = FALSE}
ggplot(gdp_south_asia,
       aes(x = year,
           y = gdp_per_cap,
           group = country,
           color = country)) +
  geom_line(size = 1.5) +
  geom_text(aes(label = label_first)) +
  geom_text(aes(label = label_last)) +
  guides(color = FALSE)
```

`r chunk_reveal(chunk_name = "slopegraph-sa-simple-text-fancier", widths = default_width)`

---

```{r slopegraph-sa-getting-warmer, include = FALSE}
ggplot(gdp_south_asia,
       aes(x = year,
           y = gdp_per_cap,
           group = country,
           color = country)) +
  geom_line(size = 1.5) +
  geom_text_repel(aes(label = label_first)) +
  geom_text_repel(aes(label = label_last)) +
  guides(color = FALSE)
```

`r chunk_reveal(chunk_name = "slopegraph-sa-getting-warmer", widths = default_width)`

---

```{r slopegraph-sa-done, include = FALSE}
ggplot(gdp_south_asia,
       aes(x = year,
           y = gdp_per_cap,
           group = country,
           color = country)) +
  geom_line(size = 1.5) +
  geom_text_repel(aes(label = label_first), direction = "y", nudge_x = -1, seed = 1234) +
  geom_text_repel(aes(label = label_last), direction = "y", nudge_x = 1, seed = 1234) +
  guides(color = FALSE) +
  scale_color_viridis_d(option = "magma", end = 0.9) +
  theme_void()
```

`r chunk_reveal(chunk_name = "slopegraph-sa-done", widths = default_width)`

---

# Bump charts

---

```{r filter-bump-data}
(sa_co2 <- wdi_clean %>% 
  filter(region == "South Asia") %>% 
  filter(year >= 2004, year < 2015) %>% 
  group_by(year) %>% 
  mutate(rank = rank(co2_emissions)))
```

---

```{r make-bump-plot, include = FALSE}
ggplot(sa_co2,
       aes(x = year,
           y = rank,
           color = country)) +
  geom_line() +
  geom_point() +
  scale_y_reverse(breaks = 1:8)
```

`r chunk_reveal(chunk_name = "make-bump-plot", widths = default_width)`

---

```{r bump-plot-fancier, include = FALSE}
ggplot(sa_co2,
       aes(x = year,
           y = rank,
           color = country)) +
  geom_line(size = 2) +
  geom_point(size = 4) +
  geom_text(data = filter(sa_co2, year == 2004),
            aes(label = iso2c, x = 2003.25),
            fontface = "bold") +
  geom_text(data = filter(sa_co2, year == 2014),
            aes(label = iso2c, x = 2014.75),
            fontface = "bold") +
  guides(color = FALSE) +
  scale_y_reverse(breaks = 1:8) +
  scale_x_continuous(breaks = 2004:2014) +
  scale_color_viridis_d(option = "magma", begin = 0.2, end = 0.9) +
  labs(x = NULL, y = "Rank") +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

`r chunk_reveal(chunk_name = "bump-plot-fancier", font_size_code = "60%", widths = default_width)`
