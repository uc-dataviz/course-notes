---
title: "Introduction to data visualization"
author: "MACS 24000 <br /> University of Chicago"
output: rcfss::xaringan
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(cache = TRUE, message = FALSE, echo = FALSE,
                      fig.retina = 2, fig.width = 12, fig.align = "center")

set.seed(1234)
```

```{r packages, include = FALSE, cache = FALSE}
library(tidyverse)
library(knitr)
library(stringr)
library(broom)
library(datasauRus)
library(gganimate)
library(socviz)
library(patchwork)
library(rcfss)
library(tidycensus)
library(statebins)
library(here)

theme_set(theme_minimal(base_size = rcfss::base_size))
```

# Why visualize data?

* Statistical methods
* Machine learning
* Drawing a picture

---

# Anscombe's quartet

```{r anscombe}
# tidy the dataset
# source: https://gist.github.com/amoeba/7576126
anscombe_tidy <- map_df(.x = 1:4, ~ tibble(set = .x,
                                           x = anscombe[, .x],
                                           y = anscombe[, .x + 4]))

ggplot(data = anscombe_tidy,
       mapping = aes(x = x, y = y)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  facet_wrap(~ set) +
  labs(title = "Anscombe's quartet",
       x = expression(X),
       y = expression(Y))
```

---

# Datasaurus dozen

```{r datasaurus-graph}
ggplot(datasaurus_dozen, aes(x = x, y = y)) +
  geom_point() +
  theme_minimal() +
  transition_states(dataset, 3, 1) + 
  ease_aes('cubic-in-out')
```

---

# Datasaurus dozen

.center[

```{r datasaurus-graph-static, fig.height = 8, fig.width = 8}
ggplot(datasaurus_dozen, aes(x = x, y = y)) +
  facet_wrap(~ dataset) +
  geom_point() +
  theme_minimal()
```

]

---

# Outlier detection

```{r south-africa-outlier, out.height = "500px"}
knitr::include_graphics("https://socviz.co/assets/ch-01-jackman-outlier.png")
```

---

# What makes visualizations bad

---

# Lies

```{r gas, out.width = "150%"}
knitr::include_graphics(here("images", "cost_of_gas.jpg"))
```

---

# Dual axes

```{r nic-cage}
knitr::include_graphics(here("images", "drowning_cage.jpeg"))
```

---

# Lacking functionality

```{r bush-tax-cuts, out.width = "130%"}
knitr::include_graphics(here("images", "Bush_cuts2.png"))
```

---

# Lacking functionality

```{r gun-deaths}
knitr::include_graphics(here("images", "stand_your_ground.jpg"))
```

---

# Junky

```{r death-penalty, out.width = "130%"}
knitr::include_graphics(here("images", "death_penalty.jpg"))
```

---

# Purpose of visualizations

> Any kind of visual representation of information designed to enable communication, analysis, discovery, exploration, etc.

--

* What is your goal?
* How do you design a visualization to meet that goal?

---

# Statistical graphics

* Visualize abstract data typically of the quantitative form
* Convey data accurately and reveal the underlying structure
* Lack exploration and interaction

---

# Double-time bar charts

```{r double-bar-chart, out.width = "150%"}
knitr::include_graphics("https://dougmccune.com/blog/wp-content/uploads/2011/04/burglary1.png")
```
    
---

# Double-time bar charts

```{r double-bar-chart-facet}
knitr::include_graphics("https://dougmccune.com/blog/wp-content/uploads/2011/04/small_multiples_small.png")
```

---

# Information dashboards

* Popular in business and industry
* Visualize abstract data, frequently (though not always) over time
* Convey large amounts of information quickly
* Extremely dense

--

#### Examples

* [COVID-19 United States Cases by County](https://coronavirus.jhu.edu/us-map)
* [California COVID Assessment Tool](https://calcat.covid19.ca.gov/cacovidmodels/) - built in Shiny!

---

# Infographics

* Depict abstract data in an effort to be eye-catching and capture attention
* Convey information quickly
* Easy to go wrong

---

# Sexual sun stroke

```{r sexual-sun-stroke}
knitr::include_graphics("https://klientboost.com/wp-content/uploads/2013/05/1.jpg")
```

---

# What is that?

```{r terrible-area-chart}
knitr::include_graphics("https://i.kinja-img.com/gawker-media/image/upload/b5icpqdsnzsdaezvnrm1.jpg")
```

---

# Huh?

```{r paid-maternity-leave, out.height = "500px"}
knitr::include_graphics("https://68.media.tumblr.com/fd2be427c6794cc8e25bc23c42da73aa/tumblr_omvcm7m9va1sgh0voo1_1280.jpg")
```

---

# What makes a good visualization

From *The Truthful Art*

* Is it truthful?
* Is it functional?
* Is it beautiful?
* Is it insightful?
* Is it enlightening?

---

# Dr. John Snow

```{r snow, out.width = "70%"}
knitr::include_graphics("https://upload.wikimedia.org/wikipedia/commons/thumb/2/27/Snow-cholera-map-1.jpg/819px-Snow-cholera-map-1.jpg")
```

---

# Napoleon's march on Russia

```{r minard-orig}
knitr::include_graphics("https://upload.wikimedia.org/wikipedia/commons/2/29/Minard.png")
```

---

# Napoleon's march on Russia

```{r minard-translate}
knitr::include_graphics("https://upload.wikimedia.org/wikipedia/commons/e/e2/Minard_Update.png")
```


---

# Perception and data visualization

* Driven by science
* Lots to learn here, but we don't have time this week to dive in deep!
* Important to remember human perception and cognition is a process - design visualizations remembering this fact
* Work to simplify perception so the story is clear and easy to tell

---

# Visual tasks and decoding graphs

```{r cleveland}
knitr::include_graphics("https://socviz.co/assets/ch-01-cleveland-task-types.png")
```

---

# Visual tasks and decoding graphs

```{r cleveland-replication, out.height = "500px"}
knitr::include_graphics("https://socviz.co/assets/ch-01-heer-bostock-results.png")
```

---

# Channels and decoding information

```{r channels-ordered-data, out.height = "500px"}
knitr::include_graphics("https://socviz.co/assets/ch-01-channels-for-cont-data-vertical.png")
```

---

# Channels and decoding information

```{r channels-unordered-data, out.height = "500px"}
knitr::include_graphics("https://socviz.co/assets/ch-01-channels-for-cat-data-vertical.png")
```

---

# Bar chart vs. pie chart

```{r bar-pie}
gss_auth <- gss_colrac %>%
  count(authoritarianism) %>%
  mutate(authoritarianism = factor(authoritarianism)) %>%
  mutate(pct = n / sum(n))

# bar chart
auth_bar <- ggplot(gss_auth, aes(authoritarianism, pct, fill = authoritarianism)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "OrRd", guide = FALSE) +
  labs(x = "Authoritarianism scale\n(higher indicates more support for authoritarian government)",
       y = "Percentage of respondents")

# pie chart
auth_pie <- ggplot(gss_auth, aes(x = factor(1), y = pct, fill = authoritarianism)) +
  geom_col(width = 1) +
  geom_text(aes(label = authoritarianism), position = position_stack(vjust = 0.5), size = 7) +
  coord_polar(theta = "y", direction = -1) +
  scale_fill_brewer(palette = "OrRd", guide = FALSE) +
  labs(x = "Authoritarianism scale\n(higher indicates more support for authoritarian government)",
       y = "Percentage of respondents") +
  theme_void(base_size = rcfss::base_size)

auth_bar +
  auth_pie +
  plot_annotation(title = "Public support for authoritarianism",
                  caption = "Source: General Social Survey (2012)",
                  tag_levels = "A") +
  plot_layout(widths = c(50, 50))
```

---

# Choropleths

```{r maps, fig.asp = .8}
us_sf <- get_acs(geography = "state", 
                 variables = c(medincome = "B19013_001"), 
                 year = 2016,
                 geometry = TRUE,
                 shift_geo = TRUE)

trump_map <- left_join(us_sf, election, by = c("NAME" = "state")) %>%
  ggplot(mapping = aes(fill = pct_trump)) +
  geom_sf() +
  scale_fill_distiller(palette = "Reds", labels = scales::percent_format(scale = 1)) +
  labs(fill = "Percent Trump") +
  theme_void() +
  theme(legend.position = "bottom")

trump_statebins <- ggplot(data = election, mapping = aes(state = state, fill = pct_trump)) +
  geom_statebins()  +
  coord_equal() +
  scale_fill_distiller(palette = "Reds", labels = scales::percent_format(scale = 1), guide = FALSE) +
  labs(fill = "Percent Trump") +
  theme_statebins(base_size = rcfss::base_size) +
  theme(legend.position = "bottom")

# lollipop chart
trump_lollipop <- ggplot(data = election,
                         mapping = aes(y = reorder(state, pct_trump), x = pct_trump,
                                       color = pct_trump)) +
  geom_pointrange(aes(xmin = 0, xmax = pct_trump),
                  fatten = 3, size = .7) +
  scale_color_distiller(palette = "Reds", labels = scales::percent_format(scale = 1), guide = FALSE) +
  labs(y = NULL,
       x = "Percent Trump") +
  theme_minimal(base_size = rcfss::base_size * .6)

(trump_lollipop | (trump_map / trump_statebins +
                     plot_layout(guides = "collect"))) +
  plot_annotation(title = "2016 US Presidential Election", tag_levels = "A") +
  plot_layout(ncol = 2, byrow = FALSE) &
  theme(legend.position = 'bottom')
```

---

# Identifying appropriate graphical forms

1. Think about the task or tasks you want to enable
1. Try different graphic forms
1. Arrange the components of the graphic
1. Test the outcomes

---

# What is the story?

```{r piketty, out.height = "500px", out.width = "340px"}
knitr::include_graphics(here("images", "ta_piketty.jpeg"))
```

---

# Midday break


---

# Grammar

> The whole system and structure of a language or of languages in general, usually taken as consisting of syntax and morphology (including inflections) and sometimes also phonology and semantics.

--

## Grammar of graphics

* "The fundamental principles or rules of an art or science"
* A grammar used to describe and create a wide range of statistical graphics
* Layered grammar of graphics
    * `ggplot2`

---

# Layered grammar of graphics

* Layer
    * Data
    * Mapping
    * Statistical transformation (stat)
    * Geometric object (geom)
    * Position adjustment (position)
* Scale
* Coordinate system (coord)
* Faceting (facet)
* Defaults
    * Data
    * Mapping

---

# Layer

**Layers** are used to create the objects on a plot. They are defined by five basic parts:

1. Data
1. Mapping
1. Statistical transformation (stat)
1. Geometric object (geom)
1. Position adjustment (position)

---

# Layered graph

```{r layers}
tibble(x = runif(50),
       y = x + rnorm(50, 0, .2)) %>%
  ggplot(mapping = aes(x = x, y = y)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "A plot with two layers",
       subtitle = "A scatterplot and a smoothing line")
```

---

# Data and mapping

* Defines the source of the information to be visualized
* Independent from the other elements

---

# `county_data`

```{r county-data}
county_data <- as_tibble(county_data) %>%
  drop_na(hh_income, per_dem_2016, flipped, pop_dens)
glimpse(county_data)
```

---

# Mapping

* Defines how the variables are applied to the plot

--

```{r mapping, dependson = "county-data", echo = TRUE}
county_data %>%
  select(hh_income, per_dem_2016) %>%
  rename(
    x = hh_income,
    y = per_dem_2016
  )
```

---

# Statistical transformation

* Transforms the data through some sort of summarization
* Bar chart
* Smoothing lines
* `stat_*()`

--

.pull-left[

```{r stat_raw, dependson = "county-data", echo = TRUE}
county_data %>%
  select(state)
```

]

.pull-right[

```{r stat_transform, dependson = "county-data", echo = TRUE}
county_data %>%
  count(state)
```

]

---

# Geometric objects

* Control the type of plot you create

--


* 0 dimensions - point, text
* 1 dimension - path, line
* 2 dimensions - polygon, interval

---

# `geom_point()`

.pull-left[

```{r geom_point, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot(
  data = county_data,
  mapping = aes(
    x = hh_income,
    y = per_dem_2016,
    color = flipped
  )
) +
  geom_point() +
  ggtitle("A point geom with position and color aesthetics")
```

]

.pull-right[

```{r geom-point-out, ref.label = "geom_point", eval = TRUE, echo = FALSE}
```
]

---

# `geom_bar()`

.pull-left[

```{r geom_bar, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot(data = county_data,
       mapping = aes(x = pop_dens)) +
  geom_bar() +
  ggtitle("A bar geom with position and height aesthetics")
```

]

.pull-right[

```{r geom-bar-out, ref.label = "geom_bar", echo = FALSE, eval = TRUE}
```

]


---

# Position adjustment

.pull-left[

```{r position_stack, dependson = "county-data", echo = TRUE, eval = FALSE}
count(x = county_data, su_gun4, pop_dens) %>%
  ggplot(mapping = aes(x = pop_dens,
                       y = n,
                       fill = su_gun4)) +
  geom_bar(stat = "identity") +
  ggtitle(label = "A stacked bar chart")
```

]

.pull-right[

```{r position-stack-out, ref.label = "position_stack", echo = FALSE, eval = TRUE}
```

]

---

# Position adjustment

.pull-left[

```{r position_dodge, dependson = "county-data", echo = TRUE, eval = FALSE}
count(x = county_data, su_gun4, pop_dens) %>%
  ggplot(mapping = aes(x = pop_dens,
                       y = n,
                       fill = su_gun4)) +
  geom_bar(stat = "identity",
           position = "dodge") +
  ggtitle(label = "A dodged bar chart")
```

]

.pull-right[

```{r position-dodge-out, ref.label = "position_dodge", echo = FALSE, eval = TRUE}
```

]

---

# Jittering

.pull-left[

```{r position, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot(
  data = county_data,
  mapping = aes(x = pop_dens,
                y = per_dem_2016)
) +
  geom_point() +
  ggtitle("A point geom with obscured data points")

ggplot(
  data = county_data,
  mapping = aes(x = pop_dens,
                y = per_dem_2016)
) +
  geom_jitter() +
  ggtitle("A point geom with jittered data points")
```

]

.pull-right[

```{r position-out, ref.label = "position", echo = FALSE, eval = TRUE}
```

]

---

# Scale

* How data is mapped to aesthetic attributes

---

# Scale

.pull-left[

```{r scale_color, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot(
  data = county_data,
  mapping = aes(
    x = hh_income,
    y = per_dem_2016,
    color = pop_dens
  )
) +
  geom_point()
```

]

.pull-right[

```{r scale-color-out, ref.label = "scale_color", echo = FALSE, eval = TRUE, fig.width = 8}
```

]

---

# Scale

.pull-left[

```{r scale_color_palette, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot(
  data = county_data,
  mapping = aes(
    x = hh_income,
    y = per_dem_2016,
    color = pop_dens
  )
) +
  geom_point() +
  scale_color_brewer(type = "seq")
```

]

.pull-right[

```{r scale-color-palette-out, ref.label = "scale_color_palette", echo = FALSE, eval = TRUE, fig.width = 8}
```

]

---

# Coordinate system

* Maps the position of objects onto the plane of the plot
* Controls how the axes and grid lines are drawn
* [Cartesian coordinate system](https://en.wikipedia.org/wiki/Cartesian_coordinate_system)

---

# Coordinate system

```{r coord_cart}
x1 <- c(1, 10)
y1 <- c(1, 5)
p <- qplot(x = x1, y = y1, geom = "blank", xlab = NULL, ylab = NULL)
p +
  ggtitle(label = "Cartesian coordinate system")
```

---

# Semi-log

```{r coord_semi_log, dependson = "coord_cart"}
p +
  coord_trans(y = "log10") +
  ggtitle(label = "Semi-log coordinate system")
```

---

# Polar

```{r coord_polar, dependson = "coord_cart"}
p +
  coord_polar() +
  ggtitle(label = "Polar coordinate system")
```

---

# Faceting

* Multiple panels
* Same graph, different subsets of observations
* Avoids use of `for` loops

---

# Faceting

.pull-left[

```{r facet, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot(
  data = county_data,
  mapping = aes(x = hh_income,
                y = per_dem_2016)
) +
  geom_point() +
  facet_wrap(~pop_dens)
```

]

.pull-right[

```{r facet-out, ref.label = "facet", echo = FALSE, eval = TRUE, fig.width = 8}
```

]

---

# Defaults

```{r default, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot() +
  layer(
    data = county_data, mapping = aes(x = hh_income, y = per_dem_2016),
    geom = "point", stat = "identity", position = "identity"
  ) +
  scale_x_continuous() +
  scale_y_continuous() +
  coord_cartesian()
```

---

# Simplify

```{r default2, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot() +
  geom_point(
    data = county_data,
    mapping = aes(x = hh_income, y = per_dem_2016)
  )
```

---

# Simplify

```{r default3, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot(
  data = county_data,
  mapping = aes(x = hh_income, y = per_dem_2016)
) +
  geom_point()
```

---

# Simplify

```{r default4, dependson = "county-data", echo = TRUE, eval = FALSE}
ggplot(county_data, aes(hh_income, per_dem_2016)) +
  geom_point()
```

---

# Add additional layers

```{r default5, dependson = "county-data", echo = TRUE}
ggplot(county_data, aes(hh_income, per_dem_2016)) +
  geom_point() +
  geom_smooth()
```

---

# Add additional layers

```{r default6, dependson = "county-data", echo = TRUE, error = TRUE}
ggplot(county_data) +
  geom_point(aes(hh_income, per_dem_2016)) +
  geom_smooth()
```

---

# Building Minard's map in R

```{r minard_data}
# get data on troop movements and city names
troops <- read_table("https://cfss.uchicago.edu/data/minard-troops.txt")
cities <- read_table("https://cfss.uchicago.edu/data/minard-cities.txt")
```

.pull-left[

## `troops`

```{r minard-troops, dependson = "minard_data"}
print(troops, n = 10)
```

]

.pull-right[

## `cities`

```{r minard-cities, dependson = "minard_data"}
print(cities, n = 10)
```

]

---

# Minard's grammar

.pull-left[

* Troops
    * Latitude
    * Longitude
    * Survivors
    * Advance/retreat
* Cities
    * Latitude
    * Longitude
    * City name
    
]

.pull-right[

* Layer
    * Data
    * Mapping
    * Statistical transformation (stat)
    * Geometric object (geom)
    * Position adjustment (position)
* Scale
* Coordinate system
* Faceting

]
